<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="utf-8">
  <title>Báo giá</title>
  <meta name="csrf-token" content="MHMXdIG4tBlzbq7sMs8y0wjq43Dtbf8PaMgnKDS3">
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <link rel="shortcut icon" href="https://rndwows.github.io/hcnswows/logowows.jpg" type="image/x-icon">
  <!-- jQuery library -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.slim.min.js"></script>

  <!-- Popper JS -->
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>

  <!-- Latest compiled JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />

  <style>
    body {
      background: rgb(204, 204, 204);
      font-family: "Times New Roman", Times, serif;
    }

    .fixed-button {
      position: fixed;
      bottom: 20px;
      /* Điều chỉnh vị trí từ dưới lên, bạn có thể thay đổi giá trị này */
      right: 20px;
      /* Điều chỉnh vị trí từ phải sang, bạn có thể thay đổi giá trị này */
      width: 100%;
      max-width: 200px;
      /* Điều chỉnh chiều rộng tối đa của button */
    }

    page {
      background: white;
      display: block;
      margin: 0 auto;
      margin-bottom: 0.5cm;
      box-shadow: 0 0 0.5cm rgba(0, 0, 0, 0.5);
    }

    page[size="A4"][layout="landscape"] {
      width: 29.7cm;
      height: 100%;

    }




    @media print {

      body,
      #content {
        margin: 0;
        box-shadow: 0;
        font-size: 18px !important;
      }

      h5 {
        font-size: 24px
      }

      .big-title {
        font-size: 18px !important;
      }

      .total-pay {
        font-size: 15px !important;
      }

      @page {
        size: auto;
      }

      #content-split {
        margin-top: 40px;
        position: absolute;
        top: 50%;
        width: 920px;
      }

      .height_hr {
        border-top: 3px dashed black;
        width: 100%;
        position: absolute;
        top: 49%;
      }

      #content-split .div-logo {
        position: relative;
        top: -10px;
        left: 10px;
      }
    }

    #content {
      font-size: 13.5px;

    }


    .center {
      text-align: center;
    }

    .right {
      text-align: right;
    }

    .bold {
      font-weight: bold;
    }

    .big-title {
      font-size: 15px;
    }

    #fixed-panel,
    #fixed-show-user,
    #fixed-show-reason {
      font-size: 13px;
    }


    #content {
      padding: 40px 40px;
    }

    #select-setup-print {
      position: relative;
      top: -2px;
      background-color: #17a2b8;
      color: white;
    }

    #setup-print {
      position: fixed;
      top: 480px;
      left: 30px;
      width: 150px;
      height: 54px;
      background-color: #ffffff;
      padding: 10px;
      border-radius: 5px;
      /*font-size: 13px;*/
      box-shadow: 0 0 0.5cm rgba(0, 0, 0, 0.5);
    }


    .heigth-90px {
      height: 90px !important;
    }

    #page {
      margin-top: 20px;
      margin-bottom: 20px;
      position: relative;
    }

    .center-content {
      text-align: center;
      vertical-align: middle;
    }

    .big-title {
      text-transform: uppercase;
      font-weight: bold;
      /*font-size: 15px;*/
      padding-bottom: 5px;
    }

    hr {
      margin-top: 5px;
      margin-bottom: 5px;
    }

    .bold {
      font-weight: bold;
    }

    .table-center th {
      text-align: center;
      vertical-align: middle;
    }

    .info_student {
      margin-top: 10px;
      text-align: justify;
    }

    .info_contract {
      margin-bottom: 5px !important
    }

    .preserve-format {
      white-space: pre-wrap;
      word-wrap: break-word;
    }


    @media only screen and (max-width: 1024px) {
      #fixed-panel {
        display: none !important;
      }

      #list_option_print {
        display: none !important;
      }
    }
  </style>

</head>

<body>
  <button onclick="print()" class="btn btn-info fixed-button" style="width: 100%"><i class="fa fa-print"></i> <span
      class="language_print"></span></button>
  <page size="A4" id="page" layout="landscape">
    <div id="content">
      <div class="content_page1">
        <table style="width: 100%;">
          <tr>
            <th rowspan="4"> <img src="https://rndwows.github.io/hcnswows/logowows.jpg"
                style="width: 100px; margin: -30px"></th>
            <th style="width: 60%;" rowspan="4" class="center">
              <h5 class=" bold">CÔNG TY CỔ PHẦN TẬP ĐOÀN WOWS</h5>
              <h5 class=" bold">PHỤ LỤC 3: HẠNG MỤC BỔ SUNG
              </h5>
            </th>
            <td style="font-size: 12px;">Mã hiệu: </th>
            <td style="font-size: 12px;"><span>PKD-QT02/PL03</span></th>
          </tr>
          <tr>
            <td style="font-size: 12px;"> Lần ban hành: 01</td>
            <td style="font-size: 12px;">Hiệu chỉnh lần: 00</td>
          </tr>
          <tr>
            <td style="font-size: 12px;">Ngày ban hành: <span>01/07/2024</td>
            <td style="font-size: 12px;">Ngày hiệu chỉnh: <span>00</td>
          </tr>
          <tr>
            <td style="font-size: 12px;">Số:</td>
            <td style="font-size: 12px;"><span id="idbg"></span></td>
          </tr>
        </table>


        <div style="clear: both"></div>
        <br>
        <p><strong>Kính gửi: <span id="companyName"></span></strong></p>
        <p>- Căn cứ hợp đồng số: <span id="idhd"></span> giữa CÔNG TY CỔ PHẦN TẬP ĐOÀN WOWS VÀ <span id="companyName"></span> về việc thỏa thuân cung cấp xây dựng hệ thống quản lý dữ liệu</p>
        <p>Hai bên thống nhất và lập phụ lục hợp đồng này bổ sung thêm hạng mục chi tiết như sau:</p>

        <table class="table table-bordered">
          <thead class="center-content">
            <tr>
              <th rowspan="2" class="center">STT</th>
              <th colspan="7">THÔNG TIN SẢN PHẨM</th>

              <th rowspan="2" class="center">GHI CHÚ</th>
            </tr>
            <tr>
              <th>Mã sản phẩm</th>
              <th>Tên sản phẩm</th>
              <th>Quy cách</th>
              <th>Đơn vị tính</th>
              <th>Số lượng</th>
              <th>Đơn giá</th>
              <th>Tổng giá trị <BR>
                (Giá gốc)</th>

            </tr>
          </thead>
          <tbody id="orderDetailsBody">
            <!-- Dữ liệu sẽ được điền vào đây bằng JavaScript -->
          </tbody>
          <tfoot>
            <tr>
              <td colspan="6" class="text-center"><strong>TỔNG GIÁ TRỊ:</strong></td>
              <td colspan="1" class="text-center"><span id=""></span></td>
              <td colspan="3" class="text-center"><span id="tongGiaTri"></span></td>
            </tr>
            <tr>
              <td colspan="6" class="text-center"><strong>% ƯU ĐÃI:</strong></td>
              <td colspan="1" class="text-center"><span id="phanTramUuDai"></span></td>
              <td colspan="3" class="text-center"><span id="tongTienUuDai"></span></td>
            </tr>
            <tr>
              <td colspan="6" class="text-center"><strong>VAT:</strong></td>
              <td colspan="1" class="text-center"><span id="vat"></span></td>
              <td colspan="3" class="text-center"><span id="tongTienVAT"></span></td>
            </tr>
            <tr>
              <td colspan="6" class="text-center"><strong>TỔNG THANH TOÁN:</strong></td>
              <td colspan="1" class="text-center"><span id=""></span></td>
              <td colspan="3" class="text-center"><span id="tongThanhToan"></span></td>
            </tr>
          </tfoot>
        </table>
        <div class="mt-3">
          <span style="font-style: italic;">TỔNG THANH TOÁN BẰNG CHỮ: </span>
          <span id="tongThanhToanBangChu" style="font-style: italic;"></span>
        </div>
        <ul id="ghiChu">
          <!-- Nội dung ghi chú sẽ được thêm vào đây bằng JavaScript -->
        </ul>
        <div id="thanhToanInfo" class="mt-4">
          <!-- Thông tin thanh toán sẽ được thêm vào đây -->
        </div>
        <div id="footerInfo" class="mt-4">
          <!-- Thông tin cuối sẽ được thêm vào đây -->
        </div>
      </div>
    </div>
  </page>


  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/printThis/1.15.0/printThis.min.js"
    integrity="sha512-d5Jr3NflEZmFDdFHZtxeJtBzk0eB+kkRXWFQqEc1EKmolXjHm2IKCA7kTvXBNjIYzjXfD5XzIjaaErpkZHCkBg=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.centeronline.edu.vn/js/customer.js" type="text/javascript"></script>
  <script>

    const API_URL = 'https://script.google.com/macros/s/AKfycby0CN2PJz82pt3taF14DUM17sc7xBbsaWWtmsJ1S6JhEPHwB4IZNL57XJqHu-ZqvaQ-UQ/exec';
    // Biến toàn cục để lưu trữ dữ liệu
    var PLHĐ = [];
    var KHTN = {};
    var DKTT = [];

    function searchOrder(maPO, soPL) {
      fetch(`${API_URL}?MAPO=${encodeURIComponent(maPO)}&SOPL=${encodeURIComponent(soPL)}`)
        .then(response => response.json())
        .then(data => {

          PLHĐ = data.po || [];
          KHTN = data.khtn || {};
          DKTT = data.dktt || [];

          updateUI();

        })
        .catch(error => {
          console.error('Đã xảy ra lỗi:', error.message);
        });
    }
    function formatCurrency(value) {
      if (!value || value == 0) return '0 ₫';
      return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return dateString;
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = String(date.getFullYear());
      return `${day}/${month}/${year}`;
    }

    // Hàm này sẽ được gọi sau khi dữ liệu được cập nhật
    function updateUI() {
      console.log("Updating UI with data:", { PLHĐ, KHTN, DKTT });
      // Kiểm tra sự tồn tại của phần tử trước khi cập nhật
      const orderNumberElement = document.getElementById('orderNumber');
      if (orderNumberElement) {
        orderNumberElement.textContent = PLHĐ.ID || '';
      }
      const companyIdbgElement = document.getElementById('idbg');
      if (companyIdbgElement) {
        companyIdbgElement.textContent = PLHĐ[0]['Số phụ lục'] || '';
      }
      const hdIdbgElement = document.getElementById('idhd');
      if (hdIdbgElement) {
        hdIdbgElement.textContent = PLHĐ[0]['Số HĐ'] || '';
      }

      const companyNameElement = document.getElementById('companyName');
      if (companyNameElement) {
        companyNameElement.textContent = KHTN['TÊN CÔNG TY'] || '';
      }


      // Cập nhật bảng PO_DETAIL và tính tổng giá trị
      const tableBody = document.getElementById('orderDetailsBody');
      let tongGiaTri = 0; // Initialize total value
      let totalDiscount = 0; // Initialize total discount
      let totalVAT = 0; // Initialize total VAT
      let productCount = 0; // Initialize product count
      if (tableBody) {
        tableBody.innerHTML = '';
        PLHĐ.forEach((item, index) => {
          const row = tableBody.insertRow();
          row.innerHTML = `
        <td class="center">${index + 1}</td>
        <td>${item['Ma_HHDV'] || ''}</td>
        <td>${item['Ten_hang_hoa/dich_vu'] || ''}</td>
        <td class="preserve-format">${item['Chi_tiet_hang_hoa'] || ''}</td>
        <td>${item['DVT'] || ''}</td>
        <td>${item['So_luong'] || ''}</td>
        <td>${formatCurrency(item['Gia_ban'])}</td>
        <td>${formatCurrency(item['Thanh_tien_chi_tiet'])}<br>
            </td>
        <td>${item['Ghi chú'] || ''}</td>
      `;
          // Add Thanh_tien_chi_tiet to the total
          tongGiaTri += parseFloat(item['Thanh_tien_chi_tiet'] || 0);

          // Add % Uu_dai and %VAT to totals
          if (item['% Uu_dai'] !== undefined && !isNaN(item['% Uu_dai']) &&
            item['%VAT'] !== undefined && !isNaN(item['%VAT'])) {
            totalDiscount += parseFloat(item['% Uu_dai']);
            totalVAT += parseFloat(item['%VAT']);
            productCount++;
          }
        });
      } else {
        console.error('Không tìm thấy phần tử có id "orderDetailsBody"');
      }

      // Calculate average discount and VAT
      const averageDiscount = productCount > 0 ? totalDiscount / productCount : 0;
      const averageVAT = productCount > 0 ? totalVAT / productCount : 0;

      // Update tongGiaTri display
      document.getElementById('tongGiaTri').textContent = formatCurrency(tongGiaTri);

      // Update % Uu_dai display
      document.getElementById('phanTramUuDai').textContent = averageDiscount ? (averageDiscount * 100).toFixed(2) + ' %' : '0%';

      // Update %VAT display
      document.getElementById('vat').textContent = averageVAT ? (averageVAT * 100).toFixed(2) + ' %' : '0%';

      // Recalculate Tong_tien_UD based on average discount
      const tongTienUD = tongGiaTri * averageDiscount;
      document.getElementById('tongTienUuDai').textContent = formatCurrency(tongTienUD);

      // Recalculate Tong_tien_VAT based on average VAT
      const tongTienVAT = (tongGiaTri - tongTienUD) * averageVAT;
      document.getElementById('tongTienVAT').textContent = formatCurrency(tongTienVAT);

      // Recalculate Tong_tien_sau_VAT
      const tongTienSauVAT = (tongGiaTri - tongTienUD) * (1 + averageVAT);
      document.getElementById('tongThanhToan').textContent = formatCurrency(tongTienSauVAT);
      document.getElementById('tongThanhToanBangChu').textContent = `${numberToWords(Math.round(tongTienSauVAT))} đồng`;

      const ghiChuList = document.getElementById('ghiChu');

      const thanhToanInfo = document.getElementById('thanhToanInfo');
      let thanhToanHTML = `
    <div class="info_student">
        <table style="width: 100%;">
            <tr>
                <td colspan="2"><span class="bold">Điều khoản thanh toán:</span></td>
            </tr>
            <tr>
                <td colspan="2">Bên B Tức <span class="bold" id="benb">${KHTN['TÊN CÔNG TY'] || ''}</span> có trách nhiệm thanh toán cho hợp đồng theo các đợt như sau:</td>
            </tr>
  `;

      // Sắp xếp DKTT theo 'Lần thanh toán'
      DKTT.sort((a, b) => a['Lần thanh toán'] - b['Lần thanh toán']);

      DKTT.forEach((dkttItem, index) => {

        const phanTramThanhToan = parseFloat(dkttItem['%thanh toán']) || 0;
        let soTienThanhToan = tongTienSauVAT * phanTramThanhToan || 0;


        thanhToanHTML += `
    <tr>
      <td colspan="2"><span class="bold">Thanh toán lần ${dkttItem['Lần thanh toán']}: ${(phanTramThanhToan * 100).toFixed(0)}%</span></td>
    </tr>
    <tr>
      <td colspan="2">Số tiền: ${formatCurrency(soTienThanhToan)} <i>(Bằng chữ: ${numberToWords(Math.round(soTienThanhToan))} đồng)</i></td>
    </tr>
    <tr>
      <td colspan="2">${dkttItem['Nội dung yêu cầu'] || ''}</td>
    </tr>
  `;
      });

      thanhToanHTML += ` 
    <tr>
        <td colspan="2" class="bold">Phương thức thanh toán: Chuyển khoản</td>
    </tr>
    <tr>
        <td colspan="2">Số tài khoản:<span class="bold"> 0281000569347</span> </td>
    </tr>
    <tr>
        <td colspan="2">Tên chủ tài khoản: Đỗ Thị Kim Thủy</td>
    </tr>
    <tr>
        <td colspan="2">Ngân hàng thụ hưởng: Ngân Hàng Vietcombank
        </td>
    </tr>
    <tr>
        <td colspan="2">Chi nhánh NH thụ hưởng: Chi nhánh Bình Dương
        </td>
    </tr>
    </table>
  </div>
  `;

      thanhToanInfo.innerHTML = thanhToanHTML;

      // Thêm phần thông tin cuối
      const footerInfo = document.getElementById('footerInfo');
      const thoiGianThucHien = PLHĐ[0]['Thời gian thực hiện'] || '';

      const ngayBatdau = PLHĐ[0]['Ngày bắt đầu'] || '';

      let footerHTML = '';

      if (averageDiscount > 0) {
        footerHTML += `
        <p>- Các nội dụng khác trên hợp đồng sẽ được giữ nguyên và không thay đổi, <br>
        Cách làm: Wows sẽ phối hợp với <span id="companyName"></span> để xây các hạng mục công việc và bàn giao cho <span id="companyName"></span>. Wows không giữ vai trò là người thực hiện các công việc của <span id="companyName"></span>.
</p>
        <p>Thời gian thực hiện Dịch vụ: <br>
          Tổng thời gian Dự kiến: ${thoiGianThucHien} tháng. &nbsp &nbsp &nbsp  Từ ngày: ${formatDate(ngayBatdau)}

          </p>





    `;
      } else {
        footerHTML += `
        <p>- Giá ưu đãi chỉ áp dụng trong trường hợp: Khách hàng thực hiện tất cả các hạng mục như báo giá nêu trên.</p>
        <p>Bảng báo giá này được áp dụng đến hết ngày </p>
        <p><strong>Rất mong nhận được phản hồi đặt hàng từ Quý Khách hàng, Trân trọng!</strong></p>
    `;
      }

      footerHTML += `
    <table style="width: 100%; text-align: center;">
        <tr>
            
            <td style="width: 50%;"><span class="bold">CÔNG TY CỔ PHẦN TẬP ĐOÀN WOWS
                </span></td>
              <td style="width: 50%;"><span class="bold" ><span id="companyName"></span></span></td>
        </tr>
        <tr>
            <td>(Ký, đóng dấu và ghi rõ họ tên) <br> <br> <br> <br> <br> <br> </td>
            <td>(Ký, đóng dấu và ghi rõ họ tên) <br> <br> <br> <br> <br> <br> </td>
        </tr>
        <tr>
            <td>
              <p class="bold">BÀ ĐỖ THỊ KIM THỦY</p>
            </td>
            <td>
                <p style="text-transform: uppercase;" class="bold"><span id=""></span></p>
            </td>
        </tr>
        <tr>
            <td>
                <i class="">Ngày ký:...........................</i>
            </td>
            <td>
                <i class="">Ngày ký:...........................</i>
            </td>
        </tr>
    </table>
  `;

      footerInfo.innerHTML = footerHTML;
      // Cập nhật tất cả các phần tử có id="companyName" trong toàn bộ trang
document.querySelectorAll('#companyName').forEach(element => {
  element.textContent = KHTN['TÊN CÔNG TY'] || '';
});
    }

    function numberToWords(number) {
      const units = ['', 'một', 'hai', 'ba', 'bốn', 'năm', 'sáu', 'bảy', 'tám', 'chín'];
      const teens = ['mười', 'mười một', 'mười hai', 'mười ba', 'mười bốn', 'mười lăm', 'mười sáu', 'mười bảy', 'mười tám', 'mười chín'];
      const tens = ['', '', 'hai mươi', 'ba mươi', 'bốn mươi', 'năm mươi', 'sáu mươi', 'bảy mươi', 'tám mươi', 'chín mươi'];
      const scales = ['', 'nghìn', 'triệu', 'tỷ', 'nghìn tỷ', 'triệu tỷ'];

      if (number === 0) return 'không';

      function convertGroup(n) {
        let result = '';
        if (n >= 100) {
          result += units[Math.floor(n / 100)] + ' trăm ';
          n %= 100;
        }
        if (n >= 20) {
          result += tens[Math.floor(n / 10)] + ' ';
          n %= 10;
        }
        if (n >= 10) {
          result += teens[n - 10] + ' ';
        } else if (n > 0) {
          result += units[n] + ' ';
        }
        return result.trim();
      }

      let result = '';
      let scaleIndex = 0;
      while (number > 0) {
        const group = number % 1000;
        if (group !== 0) {
          result = convertGroup(group) + ' ' + scales[scaleIndex] + ' ' + result;
        }
        number = Math.floor(number / 1000);
        scaleIndex++;
      }
      // Viết hoa chữ cái đầu tiên
      result = result.trim();
      return result.charAt(0).toUpperCase() + result.slice(1);
    }

    // Đảm bảo rằng DOM đã được tải trước khi thực hiện tìm kiếm
    document.addEventListener('DOMContentLoaded', function () {
      const urlParams = new URLSearchParams(window.location.search);
      const maPO = urlParams.get('maPO');
      const soPL = urlParams.get('soPL');
      if (maPO) {
        searchOrder(maPO, soPL);
      } else {
        console.error('Vui lòng cung cấp mã đơn hàng trong URL (ví dụ: ?maPO=BGA-KTS-0001)');
      }
    });
    // Tự động tìm kiếm khi trang được tải
    window.onload = function () {
      const urlParams = new URLSearchParams(window.location.search);
      const maPO = urlParams.get('maPO');
      if (maPO) {
        searchOrder(maPO);
      } else {
        console.error('Vui lòng cung cấp mã đơn hàng trong URL (ví dụ: ?maPO=BGA-KTS-0001)');
      }
    };
    function print() {
      $('#content').printThis({
        debug: false,
        importCSS: true,
        importStyle: true,
        printContainer: true,
        pageTitle: "",
        removeInline: false,
        removeInlineSelector: "*",
        printDelay: 333,
        header: null,
        footer: null,
        base: false,
        formValues: true,
        canvas: false,
        removeScripts: false,
        copyTagClasses: false,
        beforePrintEvent: null,
        beforePrint: null,
        afterPrint: null
      });
    }
  </script>
</body>

</html>