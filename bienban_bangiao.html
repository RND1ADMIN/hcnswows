<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <title>Biên bản bàn giao</title>
    <meta name="csrf-token" content="MHMXdIG4tBlzbq7sMs8y0wjq43Dtbf8PaMgnKDS3">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link rel="shortcut icon" href="https://rndwows.github.io/hcnswows/logowows.jpg" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        body {
            background: rgb(204, 204, 204);
            font-family: "Times New Roman", Times, serif;
        }
        .fixed-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 100%;
            max-width: 200px;
        }
        page {
            background: white;
            display: block;
            margin: 0 auto;
            margin-bottom: 0.5cm;
            box-shadow: 0 0 0.5cm rgba(0, 0, 0, 0.5);
        }
        page[size="A4"][layout="landscape"] {
            width: 29.7cm;
            height: 100%;
        }
        .table {
            table-layout: fixed;
            width: 100%;
        }
        .col-stt { width: 5%; }
        .col-ma-sp { width: 10%; }
        .col-ten-sp { width: 10%; }
        .col-quy-cach { width: 40%; }
        .col-dvt { width: 6%; }
        .col-so-luong { width: 5%; }
        .col-link { width: 10%; }
        .col-nguoi-nhan { width: 10%; }
        .col-ghi-chu { width: 5%; }
        .table th, .table td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        @media print {
            .table th, .table td {
                overflow: visible;
                white-space: normal;
                word-wrap: break-word;
            }
            .link-bangiao, .nguoi-tiepnhan { display: none; }
            .print-only { display: inline; }
            body, #content {
                margin: 0;
                box-shadow: 0;
                font-size: 18px !important;
            }
            h5 { font-size: 24px }
            .date-input { display: none; }
            .no-print { display: none; }
            .big-title { font-size: 18px !important; }
            .total-pay { font-size: 15px !important; }
            @page { size: auto; }
            #content-split {
                margin-top: 40px;
                position: absolute;
                top: 50%;
                width: 920px;
            }
            .height_hr {
                border-top: 3px dashed black;
                width: 100%;
                position: absolute;
                top: 49%;
            }
            #content-split .div-logo {
                position: relative;
                top: -10px;
                left: 10px;
            }
            #sequenceNumber { display: none; }
        }
        #content { font-size: 13.5px; padding: 40px 40px; }
        .center { text-align: center; }
        .right { text-align: right; }
        .bold { font-weight: bold; }
        .big-title {
            font-size: 15px;
            text-transform: uppercase;
            font-weight: bold;
            padding-bottom: 5px;
        }
        .table-center th {
            text-align: center;
            vertical-align: middle;
        }
        .info_student { margin-top: 10px; text-align: justify; }
        .info_contract { margin-bottom: 5px !important; }
        .preserve-format {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .table thead th {
            vertical-align: middle;
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        .table th, .table td {
            padding: 0.75rem;
            vertical-align: top;
            border-top: 1px solid #dee2e6;
        }
        .center { text-align: center; }
        .table-bordered { border: 1px solid #dee2e6; }
        .form-control.link-bangiao, .form-control.nguoi-tiepnhan {
            width: 100%;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            line-height: 1.3;
            color: #495057;
            background-color: #fff;
            border: 1px solid #ced4da;
            border-radius: 0.2rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .table td { padding: 0.4rem; }
        @media screen { .print-only { display: none; } }
        @media only screen and (max-width: 1024px) {
            #fixed-panel, #list_option_print { display: none !important; }
        }
    </style>
</head>
<body>
    <button onclick="printDocument()" class="btn btn-info fixed-button" style="width: 100%">
        <i class="fa fa-print"></i> <span class="language_print"></span>
    </button>
    <page size="A4" id="page" layout="landscape">
        <div id="content">
            <div class="content_page1">
                <!-- Add your table and other content here -->
                <table class="table table-bordered">
                    <thead class="center-content">
                        <tr>
                            <th class="center col-stt">STT</th>
                            <th class="col-ma-sp">Mã sản phẩm</th>
                            <th class="col-ten-sp">Tên sản phẩm</th>
                            <th class="col-quy-cach">Mô tả sản phẩm</th>
                            <th class="col-dvt">Đơn vị tính</th>
                            <th class="col-so-luong">Số lượng</th>
                            <th class="col-link">Link bàn giao (Nếu có)</th>
                            <th class="col-nguoi-nhan">Người tiếp nhận</th>
                            <th class="center col-ghi-chu">Ghi chú</th>
                        </tr>
                    </thead>
                    <tbody id="orderDetailsBody">
                        <!-- Dữ liệu sẽ được điền vào đây bằng JavaScript -->
                    </tbody>
                </table>
                <!-- Add other sections here -->
            </div>
        </div>
    </page>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/printThis/1.15.0/printThis.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxBC2rStHp37z7dUcwm-_4HOnsU1y7zTxqPuuPSKgBL0Q13llL1dqn3juQ2l_2jsGHm/exec';
        var HOP_DONG = {};
        var PO_DETAIL = [];
        var KHTN = {};
        var DKTT = [];
        function searchContract(soHD) {
            fetch(`${API_URL}?SOHD=${encodeURIComponent(soHD)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        HOP_DONG = data.hop_dong || {};
                        PO_DETAIL = data.po_detail || [];
                        KHTN = data.khtn || {};
                        DKTT = data.dktt || [];
                        updateUI();
                    } else {
                        console.error('Lỗi:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Đã xảy ra lỗi:', error.message);
                });
        }
        function updateUI() {
            document.getElementById('id').textContent = HOP_DONG['Số HĐ'] || '';
            document.getElementById('companyName').textContent = KHTN['TÊN CÔNG TY'] || '';
            document.getElementById('companyAddress').textContent = KHTN['ĐỊA CHỈ'] || '';
            document.getElementById('Mst').textContent = KHTN['MST'] || '';
            document.getElementById('Nglh').textContent = KHTN['NGƯỜI LIÊN HỆ'] || '';
            document.getElementById('Chucvu').textContent = KHTN['CHỨC VỤ'] || '';
            document.getElementById('Sdt').textContent = KHTN['SỐ ĐT NGƯỜI LIÊN HỆ'] || '';
            document.getElementById('Email').textContent = KHTN['EMAIL NGƯỜI LIÊN HỆ'] || '';
            document.getElementById('Tvt').textContent = KHTN['TÊN VIẾT TẮT'] || '';
            updateProductTable();
            updateFooter();
        }
        function updateProductTable() {
            const tableBody = document.getElementById('orderDetailsBody');
            tableBody.innerHTML = PO_DETAIL.map((item, index) => `
                <tr>
                    <td class="center">${index + 1}</td>
                    <td>${item['Ma_HHDV'] || ''}</td>
                    <td>${item['Ten_hang_hoa/dich_vu'] || ''}</td>
                    <td class="preserve-format">${item['Chi_tiet_hang_hoa'] || ''}</td>
                    <td>${item['DVT'] || ''}</td>
                    <td>${item['So_luong'] || ''}</td>
                    <td>
                        <input type="text" class="form-control link-bangiao" placeholder="Nhập link bàn giao">
                        <span class="print-only"></span>
                    </td>
                    <td>
                        <input type="text" class="form-control nguoi-tiepnhan" placeholder="Nhập tên người tiếp nhận">
                        <span class="print-only"></span>
                    </td>
                    <td>${item['Ghi_chu'] || ''}</td>
                </tr>
            `).join('');
            addInputListeners();
        }
        function addInputListeners() {
            const inputs = document.querySelectorAll('.link-bangiao, .nguoi-tiepnhan');
            inputs.forEach(input => {
                input.addEventListener('input', function () {
                    const printSpan = this.nextElementSibling;
                    printSpan.textContent = this.value;
                });
            });
        }
        document.addEventListener('DOMContentLoaded', function () {
            addInputListeners();
        });
        function printDocument() {
            prepareForPrinting();
            $('#content').printThis({
                debug: false,
                importCSS: true,
                importStyle: true,
                printContainer: true,
                pageTitle: "",
                removeInline: false,
                removeInlineSelector: "*",
                printDelay: 333,
                header: null,
                footer: null,
                base: false,
                formValues: true,
                canvas: false,
                removeScripts: false,
                copyTagClasses: false,
                beforePrintEvent: null,
                beforePrint: null,
                afterPrint: function () {
                    const inputs = document.querySelectorAll('.link-bangiao, .nguoi-tiepnhan');
                    inputs.forEach(input => {
                        input.style.display = 'inline-block';
                    });
                }
            });
        }
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const soHD = urlParams.get('SOHD');
            if (soHD) {
                searchContract(soHD);
            } else {
                console.error('Vui lòng cung cấp số hợp đồng trong URL (ví dụ: ?SOHD=HD001)');
            }
        });
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = String(date.getFullYear());
            return `${day}/${month}/${year}`;
        }
        function formatCurrency(value) {
            if (!value) return '';
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
        }
        function prepareForPrinting() {
            const inputs = document.querySelectorAll('.link-bangiao, .nguoi-tiepnhan');
            inputs.forEach(input => {
                const span = input.nextElementSibling;
                span.textContent = input.value;
            });
        }
        document.addEventListener('DOMContentLoaded', function () {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = String(today.getFullYear());
            document.getElementById('day').value = day;
            document.getElementById('month').value = month;
            document.getElementById('year').value = year;
            const inputs = document.querySelectorAll('.date-input');
            inputs.forEach(function (input) {
                const span = document.createElement('span');
                span.textContent = input.value;
                input.parentNode.insertBefore(span, input.nextSibling);
                input.addEventListener('input', function () {
                    span.textContent = this.value;
                });
            });
        });
        document.addEventListener('DOMContentLoaded', function () {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            document.getElementById('currentDate').textContent = day + '.' + month;
            const sequenceInput = document.getElementById('sequenceNumber');
            const sequenceDisplay = document.getElementById('sequenceNumberDisplay');
            sequenceInput.addEventListener('input', function () {
                const value = this.value.padStart(3, '0');
                sequenceDisplay.textContent = value;
            });
        });
    </script>
</body>
</html>
